@B02
#DIM CONST HEIGHT=2
#DIM CONST WEIGHT=7
#DIM DYNAMIC HEALTH=3
#DIM COUNT2
#DIM COUNT3
#DIM STACK
#DIM POINTER
#DIM BLOCK
#DIM ENEMYLEFT
;=================
;initialize
;=================
ALIGNMENT CENTER
PRINTW 关卡0-2
PRINTL 教学关卡
ALIGNMENT LEFT
PRINTL 敌人每回合将会从左往右移动一个，部署干员阻挡他们
PRINTW 请将夜刀部署至10号位
FOR COUNT, 0, CHARANUM
    BASE:COUNT:12=-1;
    BASE:COUNT:15=BASE:COUNT:13
    BASE:COUNT:14=0
    BASE:COUNT:17=0
    BASE:COUNT:18=0
NEXT
FOR COUNT2,0,20
    FOR STACK,0,20
        FOR COUNT,0,20
            ENEMYS:COUNT2:STACK= 
            ENEMY:COUNT2:COUNT:STACK=0
            ENEMYH:COUNT2:COUNT:STACK=0            
        NEXT
    NEXT
NEXT
ENEMYLEFT=7
ROUND=0
COST=7
CALL SELECTSQUAD
$ROUNDSTART
ROUND++
COST+=2
;================
;spawn enemy
;================
COUNT=0
SELECTCASE ROUND
    CASE 2
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=1
        ENEMYH:1:6:COUNT=ENEMY_HP:1
    CASE 3
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=1
        ENEMYH:1:6:COUNT=ENEMY_HP:1
    CASE 4
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=1
        ENEMYH:1:6:COUNT=ENEMY_HP:1
    CASE 6
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=2
        ENEMYH:1:6:COUNT=ENEMY_HP:2
    CASE 7
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=2
        ENEMYH:1:6:COUNT=ENEMY_HP:2
    CASE 9
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=2
        ENEMYH:1:6:COUNT=ENEMY_HP:2
        ENEMY:1:6:(COUNT+1)=2
        ENEMYH:1:6:(COUNT+1)=ENEMY_HP:2
ENDSELECT
$INPUT_LOOP
;================
;drawmap
;================
CLEARLINE 100
PRINTFORML 剩余生命值{HEALTH}剩余敌人数{ENEMYLEFT}部署费用{COST}
DRAWLINE -
FOR COUNT2,0,HEIGHT
    ;render operator
    FOR COUNT,0,WEIGHT
        CALL GETOPERATOR_B02(COUNT,COUNT2)                                                                  ;MODIFY
        IF RESULT==-1
            PRINTFORM [{COUNT+COUNT2*WEIGHT}]可部署           
        ELSE
            PRINTFORM [{COUNT+COUNT2*WEIGHT}]%CALLNAME:RESULT%%"("%{BASE:RESULT:15}%")"%       
        ENDIF
    NEXT
    PRINTFORM \n
    ;render enemies
    FOR STACK,0,20
        COUNT3=0
        ENEMYS:COUNT2:STACK= 
        FOR COUNT,0,WEIGHT
            IF ENEMY:COUNT2:COUNT:STACK==0
                ENEMYS:COUNT2:STACK+= " "*30      
            ELSE
                ENEMYS:COUNT2:STACK+=@"%CSTRNAME:(ENEMY:COUNT2:COUNT:STACK)%{ENEMYH:COUNT2:COUNT:STACK}HP"  
                COUNT3++
            ENDIF
        NEXT
        SIF COUNT3>0||STACK==0
        PRINTFORM %ENEMYS:COUNT2:STACK%\n
    NEXT
    PRINTFORM \n
    DRAWLINE -
NEXT
PRINTFORM \n
;================
;drawmenu
;================
PRINT [900]下一步

INPUT
POINTER=RESULT
IF RESULT<HEIGHT*WEIGHT
    CALL GETOPERATOR_B02(RESULT%WEIGHT,RESULT/WEIGHT)                                       ;MODIFY                           
    IF RESULT==-1;
        CALL SELECTOP_B02(1)
        IF RESULT!=999                                                                      ;MODIFY
        IF COST>BASE:RESULT:9
            PRINTFORML %CALLNAME:RESULT%部署至{POINTER}
            PRINTW
            BASE:RESULT:12=POINTER
            BASE:RESULT:17=0
            COST-=BASE:RESULT:9
        ELSE
            PRINTW 费用不足
        ENDIF
        ENDIF
    ELSE
        CALL CONFOP_B02(POINTER%WEIGHT,POINTER/WEIGHT,RESULT)                                                             ;MODIFY
    ENDIF
ELSE
    SIF RESULT==900
        GOTO ROUNDCAL
ENDIF
GOTO INPUT_LOOP

$ROUNDCAL
;=================
;operator action
;=================
FOR COUNT2,0,HEIGHT
    FOR COUNT,0,WEIGHT
        CALL GETOPERATOR_B02(COUNT,COUNT2)          ;MODIFY
        LOCAL=RESULT
        IF LOCAL!=-1
            BASE:LOCAL:18++
            SIF BASE:LOCAL:17>0
            BASE:LOCAL:17--            
            LOCAL=NO:LOCAL
            CALLFORM ATTACK_{LOCAL}(COUNT2,COUNT,"B02")   ;MODIFY
            CALLFORM SKILL_{LOCAL}(COUNT2,COUNT,0)     
        ENDIF
    NEXT
NEXT

;=================
;enemy action
;=================
FOR COUNT2,0,HEIGHT
    FOR STACK,0,20
        FOR COUNT,0,WEIGHT
            IF ENEMY:COUNT2:COUNT:STACK!=0
                ;health
                IF ENEMYH:COUNT2:COUNT:STACK<=0
                    PRINTFORML %CSTRNAME:(ENEMY:COUNT2:COUNT:STACK)%倒下了
                    PRINTW
                    ENEMYLEFT--            
                    ENEMY:COUNT2:COUNT:STACK=0
                    ENEMYH:COUNT2:COUNT:STACK=0
                    CONTINUE
                ENDIF 
                ;attack
                CALL ENEMY_ATTACK("B02",COUNT,COUNT2,ENEMY:COUNT2:COUNT:STACK)              ;MODIFY

                FOR  COUNT3,2,CHARANUM
                    SIF BASE:COUNT3:14>0
                        BASE:COUNT3:14--                ;剩余部署时间减少
                    IF BASE:COUNT3:15<=0
                        PRINTFORMW %CALLNAME:COUNT3%倒下了
                        PRINTW
                        BASE:COUNT3:14=BASE:COUNT3:8
                        BASE:COUNT3:12=-1
                        BASE:COUNT3:15=BASE:COUNT3:13
                        CALLFORM SKILL_{NO:COUNT3}(COUNT2,COUNT,2) ;DEACTIVE SKILL
                    ENDIF
                NEXT
                ;cal block number
                CALL GETOPERATOR_B02(COUNT,COUNT2)                              ;MODIFY
                BLOCK=0
                FOR COUNT3,0,20
                    SIF ENEMY:COUNT2:COUNT:COUNT3!=0
                    BLOCK++
                NEXT
                IF RESULT==-1||BASE:RESULT:10<BLOCK ;FORWARD
                    IF COUNT==0 ;LOSE ONE
                        PRINTFORML 一个%CSTRNAME:(ENEMY:COUNT2:COUNT:STACK)%进入了蓝门
                        HEALTH-=1
                        ENEMYLEFT--
                        IF HEALTH>0
                            PRINTFORML 你手撕了%CSTRNAME:(ENEMY:COUNT2:COUNT:STACK)%，你还能手撕{HEALTH}次
                            ENEMY:COUNT2:COUNT:STACK=0
                            ENEMYH:COUNT2:COUNT:STACK=0
                            IF ENEMY:COUNT2:COUNT:(STACK+1)!=0
                                ENEMY:COUNT2:COUNT:STACK=ENEMY:COUNT2:COUNT:(STACK+1)
                                ENEMYH:COUNT2:COUNT:STACK=ENEMYH:COUNT2:COUNT:(STACK+1)
                                ENEMY:COUNT2:COUNT:(STACK+1)=0
                                ENEMYH:COUNT2:COUNT:(STACK+1)=0
                            ENDIF                            
                            PRINTW
                        ELSE
                            GOTO LOOSE   
                        ENDIF 
                    ELSE
                        COUNT3=0
                        WHILE ENEMY:COUNT2:(COUNT-1):COUNT3!=0
                            COUNT3++
                        WEND
                        ENEMY:COUNT2:(COUNT-1):COUNT3=ENEMY:COUNT2:COUNT:STACK
                        ENEMYH:COUNT2:(COUNT-1):COUNT3=ENEMYH:COUNT2:COUNT:STACK
                        ENEMY:COUNT2:COUNT:STACK=0
                        ENEMYH:COUNT2:COUNT:STACK=0
                    ENDIF
                ENDIF
                IF STACK>0&&ENEMY:COUNT2:COUNT:(STACK-1)==0
                    ENEMY:COUNT2:COUNT:(STACK-1)=ENEMY:COUNT2:COUNT:STACK
                    ENEMYH:COUNT2:COUNT:(STACK-1)=ENEMYH:COUNT2:COUNT:STACK                       
                    ENEMY:COUNT2:COUNT:STACK=0
                    ENEMYH:COUNT2:COUNT:STACK=0
                ENDIF
            ENDIF
        NEXT
    NEXT
NEXT
SIF ENEMYLEFT==0
        GOTO  VICTORY  
GOTO ROUNDSTART

$LOOSE
CALL DEACTIVE_SKILL
SETCOLOR 0xED1C24
ALIGNMENT CENTER
PRINTW 作战失败
RESETCOLOR
ALIGNMENT LEFT
RETURN

$VICTORY
CALL DEACTIVE_SKILL
SETCOLOR 0x62ED47
ALIGNMENT CENTER
PRINTW 作战成功
MONEY+=750
PRINTFORMW 获得龙门币750
IF LEVEL_A==0
    MONEY:1+=1
    PRINTW 获得源石1
ENDIF
ALIGNMENT LEFT
SIF LEVEL_A<2                                   ;MODIFY
LEVEL_A=2                                       ;MODIFY
RESETCOLOR  
RETURN


;=================
;config operator
;=================
@CONFOP_B02,ARG:0,ARG:1,ARG:2                  ;MODIFY
PRINTL [0]撤退
PRINTFORML [1]使用技能（\@BASE:(ARG:2):16==0?无技能#技能{BASE:(ARG:2):16}\@）
PRINTL [999]返回
INPUT
SELECTCASE RESULT
    CASE 0
        BASE:(ARG:2):12=-1
        BASE:(ARG:2):14=BASE:(ARG:2):8 ;重置冷却
    CASE 1
        CALLFORM SKILL_{NO:(ARG:2)}(ARG:1,ARG:0,1)
    CASE 999
        RETURN
ENDSELECT
;=================
;select operator
;=================
@SELECTOP_B02,ARG=1                             ;MODIFY
DRAWLINE =
FOR COUNT, 0, 11
    IF SQUAD:COUNT!=0
        IF BASE:(SQUAD:COUNT):12==-1
            IF BASE:(SQUAD:COUNT):14==0
                PRINTFORML [{COUNT}]%CALLNAME:(SQUAD:COUNT)%   挡{BASE:(SQUAD:COUNT):10}     {BASE:(SQUAD:COUNT):9}费   \@BASE:(SQUAD:COUNT):16==0? #技能{BASE:(SQUAD:COUNT):16}\@  
            ELSE
                PRINTFORML [冷却中]%CALLNAME:(SQUAD:COUNT)%
            ENDIF
        ENDIF
    ENDIF
NEXT
DRAWLINE =
PRINTL [999]返回
INPUT
SIF RESULT==999
    RETURN 999
RETURN SQUAD:RESULT

@GETOPERATOR_B02(ARG:0,ARG:1)               ;MODIFY
#DIM COUNT3
#DIM POS 
POS=ARG:0+ARG:1*7
SIF POS<0
    RETURN -1
FOR COUNT3, 0, CHARANUM
    SIF BASE:COUNT3:12==POS
        RETURN COUNT3
NEXT
RETURN -1