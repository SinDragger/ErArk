@EVENTSHOP

@SHOW_SHOP 
#DIM CONST HEIGHT=2
#DIM CONST WEIGHT=7
#DIM DYNAMIC HEALTH=30
#DIM DYNAMIC ENEMY,2,7,20
#DIM DYNAMIC ENEMYH,2,7,20
#DIMS DYNAMIC ENEMYS,2,20
#DIM COUNT2
#DIM COUNT3
#DIM STACK
#DIM POINTER
#DIM ROUND
#DIM BLOCK
;=================
;initialize
;=================
PRINTL 关卡0-1
FOR COUNT, 0, CHARANUM
    BASE:COUNT:22=-1;
NEXT
$ROUNDSTART
ROUND++
;================
;spawn enemy
;================
COUNT=0
SELECTCASE ROUND
    CASE 2
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=1
        ENEMYH:1:6:COUNT=1000
    CASE 3
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=1
        ENEMYH:1:6:COUNT=1000
    CASE 4
        WHILE ENEMY:1:6:COUNT!=0
            COUNT++
        WEND
        ENEMY:1:6:COUNT=1
        ENEMYH:1:6:COUNT=1000
ENDSELECT
$INPUT_LOOP
;================
;drawmap
;================
CLEARLINE 100
DRAWLINE -
FOR COUNT2,0,HEIGHT
    ;render operator
    FOR COUNT,0,WEIGHT
        CALL GETOPERATOR_B01(COUNT+COUNT2*WEIGHT)
        IF RESULT==-1
            PRINTFORM [{COUNT+COUNT2*WEIGHT}]可部署           
        ELSE
            PRINTFORM [{COUNT+COUNT2*WEIGHT}]%CALLNAME:RESULT%       
        ENDIF
    NEXT
    PRINTFORM \n
    ;render enemies
    FOR STACK,0,20
        COUNT3=0
        ENEMYS:COUNT2:STACK= 
        FOR COUNT,0,WEIGHT
            IF ENEMY:COUNT2:COUNT:STACK==0
                ENEMYS:COUNT2:STACK+= " "*30      
            ELSE
                ENEMYS:COUNT2:STACK+=@"%CSTRNAME:(ENEMY:COUNT2:COUNT:STACK)%{ENEMYH:COUNT2:COUNT:STACK}HP"  
                COUNT3++
            ENDIF
        NEXT
        SIF COUNT3>0||STACK==0
        PRINTFORM %ENEMYS:COUNT2:STACK%\n
    NEXT
    PRINTFORM \n
    DRAWLINE -
NEXT
PRINTFORM \n
;================
;drawmenu
;================
PRINT [900]下一步

INPUT
POINTER=RESULT
IF RESULT<HEIGHT*WEIGHT
    CALL GETOPERATOR_B01(RESULT)
    IF RESULT==-1;
        CALL SELECTOP(1)
        IF RESULT!=999
        PRINTFORML %CALLNAME:RESULT%部署至{POINTER}
        BASE:RESULT:22=POINTER
        ENDIF
    ELSE
        CALL CONFOP(RESULT)
    ENDIF
ELSE
    SIF RESULT==900
        GOTO ROUNDCAL
ENDIF
GOTO INPUT_LOOP

$ROUNDCAL
;=================
;enemy forward
;=================
FOR COUNT2,0,HEIGHT
    FOR STACK,0,20
        FOR COUNT,0,WEIGHT
            IF ENEMY:COUNT2:COUNT:STACK==0

            ELSE ;cal block number
                CALL GETOPERATOR_B01(COUNT+COUNT2*WEIGHT)
                BLOCK=0
                FOR COUNT3,0,20
                    SIF ENEMY:COUNT2:COUNT:COUNT3!=0
                    BLOCK++
                NEXT
                IF RESULT==-1||BASE:RESULT:27<BLOCK ;FORWARD
                    IF COUNT==0 ;LOSE ONE
                        PRINTFORML 一个%CSTRNAME:(ENEMY:COUNT2:COUNT:STACK)%进入了蓝门
                        HEALTH-=1
                        IF HEALTH>0
                            PRINTFORML 你手撕了%CSTRNAME:(ENEMY:COUNT2:COUNT:STACK)%，你还能手撕{HEALTH}次
                            ENEMY:COUNT2:COUNT:STACK=0
                            ENEMYH:COUNT2:COUNT:STACK=0                            
                            PRINTW
                        ELSE
                            PRINTL 作战失败
                            ;GOTO LOOSE   
                        ENDIF 
                    ELSE
                        COUNT3=0
                        WHILE ENEMY:COUNT2:(COUNT-1):COUNT3!=0
                            COUNT3++
                        WEND
                        ENEMY:COUNT2:(COUNT-1):COUNT3=ENEMY:COUNT2:COUNT:STACK
                        ENEMYH:COUNT2:(COUNT-1):COUNT3=ENEMYH:COUNT2:COUNT:STACK
                        ENEMY:COUNT2:COUNT:STACK=0
                        ENEMYH:COUNT2:COUNT:STACK=0
                    ENDIF
                ENDIF
            ENDIF
        NEXT
    NEXT
NEXT
GOTO ROUNDSTART
;=================
;config operator
;=================
@CONFOP,ARG
PRINTL [0]撤退
PRINTL [1]使用技能（未做完）
PRINTL [999]返回
INPUT
SELECTCASE RESULT
    CASE 0
        BASE:ARG:22=-1
        BASE:ARG:25=BASE:ARG:26
    CASE 1
    CASE 999
        RETURN
ENDSELECT
;=================
;select operator
;=================
@SELECTOP,ARG=1
DRAWLINE =
FOR COUNT, 0, CHARANUM
    SIF BASE:COUNT:24<4 && BASE:COUNT:22==-1;
        PRINTFORML [{COUNT}]%CALLNAME:COUNT%
NEXT
DRAWLINE =
PRINTL [999]返回
INPUT
RETURN RESULT

@GETOPERATOR_B01(ARG)
#DIM COUNT3
SIF ARG<0
    RETURN -1
FOR COUNT3, 0, CHARANUM
    SIF BASE:COUNT3:22==ARG
        RETURN COUNT3
NEXT
RETURN -1